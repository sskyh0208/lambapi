name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ç¨®é¡'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: 1.2.3) - æŒ‡å®šã—ãŸå ´åˆã¯ version_type ã‚’ç„¡è¦–'
        required: false
        type: string
      draft:
        description: 'ãƒ‰ãƒ©ãƒ•ãƒˆãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ä½œæˆ'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ä½œæˆ'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  prepare-release:
    name: ãƒªãƒªãƒ¼ã‚¹æº–å‚™
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
        id: current_version
        run: |
          current=$(python -c "import lambapi; print(lambapi.__version__)")
          echo "current_version=$current" >> $GITHUB_OUTPUT
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $current"

      - name: æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨ˆç®—
        id: version
        run: |
          current_version="${{ steps.current_version.outputs.current_version }}"
          version_type="${{ inputs.version_type }}"
          custom_version="${{ inputs.custom_version }}"
          
          if [ -n "$custom_version" ]; then
            new_version="$custom_version"
            echo "ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨: $new_version"
          else
            # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°è¨ˆç®—
            IFS='.' read -ra VERSION_PARTS <<< "$current_version"
            major=${VERSION_PARTS[0]}
            minor=${VERSION_PARTS[1]}
            patch=${VERSION_PARTS[2]}
            
            case $version_type in
              major)
                major=$((major + 1))
                minor=0
                patch=0
                ;;
              minor)
                minor=$((minor + 1))
                patch=0
                ;;
              patch)
                patch=$((patch + 1))
                ;;
            esac
            
            new_version="$major.$minor.$patch"
            echo "$version_type ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—: $current_version â†’ $new_version"
          fi
          
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $new_version"

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        run: |
          new_version="${{ steps.version.outputs.new_version }}"
          
          # __init__.py ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
          sed -i "s/__version__ = \".*\"/__version__ = \"$new_version\"/" lambapi/__init__.py
          
          # pyproject.toml ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
          sed -i "s/version = \".*\"/version = \"$new_version\"/" pyproject.toml
          
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ $new_version ã«æ›´æ–°ã—ã¾ã—ãŸ"

      - name: å¤‰æ›´ãƒ­ã‚°ç”Ÿæˆ
        id: changelog
        run: |
          new_version="${{ steps.version.outputs.new_version }}"
          
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$latest_tag" ]; then
            echo "åˆå›ãƒªãƒªãƒ¼ã‚¹: å…¨ã¦ã®ã‚³ãƒŸãƒƒãƒˆã‚’å«ã‚ã‚‹"
            commits=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            echo "å‰å›ã®ã‚¿ã‚°: $latest_tag"
            commits=$(git log ${latest_tag}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi
          
          # å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆ
          changelog_file=$(mktemp)
          echo "# ãƒªãƒªãƒ¼ã‚¹ v$new_version" > $changelog_file
          echo "" >> $changelog_file
          echo "## å¤‰æ›´å†…å®¹" >> $changelog_file
          echo "" >> $changelog_file
          
          if [ -n "$commits" ]; then
            echo "$commits" >> $changelog_file
          else
            echo "- å¤‰æ›´ãªã—" >> $changelog_file
          fi
          
          echo "" >> $changelog_file
          echo "## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" >> $changelog_file
          echo "" >> $changelog_file
          echo "\`\`\`bash" >> $changelog_file
          echo "pip install lambapi==$new_version" >> $changelog_file
          echo "\`\`\`" >> $changelog_file
          echo "" >> $changelog_file
          echo "## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" >> $changelog_file
          echo "" >> $changelog_file
          echo "ğŸ“š [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://sskyh0208.github.io/lambapi/)" >> $changelog_file
          
          # GitHub ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡ºåŠ›ç”¨ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          changelog_content=$(cat $changelog_file)
          {
            echo 'changelog<<EOF'
            echo "$changelog_content"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          echo "å¤‰æ›´ãƒ­ã‚°ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          new_version="${{ steps.version.outputs.new_version }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add lambapi/__init__.py pyproject.toml
          git commit -m "chore: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ v$new_version ã«æ›´æ–°" || exit 0
          git push origin main
          
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"

  create-release:
    name: GitHub ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: main  # æ›´æ–°ã•ã‚ŒãŸ main ãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨

      - name: Python ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        run: |
          python -m build

      - name: Git ã‚¿ã‚°ä½œæˆ
        run: |
          new_version="${{ needs.prepare-release.outputs.new_version }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git tag -a "v$new_version" -m "Release v$new_version"
          git push origin "v$new_version"
          
          echo "ã‚¿ã‚° v$new_version ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: GitHub ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare-release.outputs.new_version }}
          name: Release v${{ needs.prepare-release.outputs.new_version }}
          body: ${{ needs.prepare-release.outputs.changelog }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
          files: |
            dist/*

  deploy-pypi:
    name: PyPI ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    if: ${{ !inputs.draft && !inputs.prerelease }}
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: main

      - name: TestPyPI ãƒ“ãƒ«ãƒ‰ & å…¬é–‹
        uses: JRubics/poetry-publish@v2.1
        with:
          python_version: "3.13"
          poetry_version: "latest"
          pypi_token: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_name: "testpypi"
          repository_url: "https://test.pypi.org/legacy/"

      - name: TestPyPI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
        run: |
          sleep 30
          new_version="${{ needs.prepare-release.outputs.new_version }}"
          pip install -i https://test.pypi.org/simple/ lambapi==$new_version || {
            echo "âš ï¸ TestPyPI ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¾å­˜é–¢ä¿‚ã®å•é¡Œã®å¯èƒ½æ€§ï¼‰"
            echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è‡ªä½“ã¯æ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          }
          echo "âœ… TestPyPI ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: PyPI ãƒ“ãƒ«ãƒ‰ & å…¬é–‹
        uses: JRubics/poetry-publish@v2.1
        with:
          python_version: "3.13"
          poetry_version: "latest"
          pypi_token: ${{ secrets.PYPI_API_TOKEN }}

      - name: PyPI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
        run: |
          sleep 60
          new_version="${{ needs.prepare-release.outputs.new_version }}"
          pip install lambapi==$new_version || {
            echo "âŒ PyPI ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          python -c "
          from lambapi import API
          api = API({}, None, '/api/v1')
          assert api.root_path == '/api/v1'
          print('âœ… PyPI ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™')
          "

  deploy-docs:
    name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release, deploy-pypi]
    if: always() && (needs.create-release.result == 'success')
    
    steps:
      - name: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: docs-update
          client-payload: '{"version": "${{ needs.prepare-release.outputs.new_version }}"}'

  notify-completion:
    name: å®Œäº†é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release, deploy-pypi, deploy-docs]
    if: always()
    
    steps:
      - name: æˆåŠŸé€šçŸ¥
        if: needs.create-release.result == 'success'
        run: |
          new_version="${{ needs.prepare-release.outputs.new_version }}"
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ v$new_version ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“¦ GitHub Releases: https://github.com/${{ github.repository }}/releases/tag/v$new_version"
          if [ "${{ needs.deploy-pypi.result }}" = "success" ]; then
            echo "ğŸ“¦ PyPI: https://pypi.org/project/lambapi/$new_version/"
            echo "ğŸ§ª TestPyPI: https://test.pypi.org/project/lambapi/$new_version/"
            echo ""
            echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: pip install lambapi==$new_version"
          fi
          echo "ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://sskyh0208.github.io/lambapi/"

      - name: å¤±æ•—é€šçŸ¥
        if: needs.create-release.result == 'failure'
        run: |
          echo "âŒ ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"