name: PyPI ãƒ‡ãƒ—ãƒ­ã‚¤

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°å (ä¾‹: v0.1.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy-test:
    name: TestPyPI ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œè¨¼
        run: |
          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŠ½å‡º
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            release_version="${{ inputs.tag_name }}"
          else
            release_version="${{ github.event.release.tag_name }}"
          fi
          release_version=${release_version#v}  # v ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹é™¤å»
          
          # pyproject.toml ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          package_version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          
          echo "ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $release_version"
          echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $package_version"
          
          if [ "$release_version" != "$package_version" ]; then
            echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¾ã›ã‚“"
            exit 1
          fi
          
          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã—ã¾ã—ãŸ"

      - name: TestPyPI ãƒ“ãƒ«ãƒ‰ & å…¬é–‹
        uses: JRubics/poetry-publish@v2.1
        with:
          python_version: "3.13"
          poetry_version: "latest"
          pypi_token: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_name: "testpypi"
          repository_url: "https://test.pypi.org/legacy/"

      - name: TestPyPI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
        run: |
          # TestPyPI ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãƒ†ã‚¹ãƒˆ
          sleep 30  # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åæ˜ ã‚’å¾…ã¤
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            release_version="${{ inputs.tag_name }}"
          else
            release_version="${{ github.event.release.tag_name }}"
          fi
          release_version=${release_version#v}
          
          pip install -i https://test.pypi.org/simple/ lambapi==$release_version || {
            echo "âš ï¸ TestPyPI ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¾å­˜é–¢ä¿‚ã®å•é¡Œã®å¯èƒ½æ€§ï¼‰"
            echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è‡ªä½“ã¯æ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          }
          
          echo "âœ… TestPyPI ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"

  deploy-production:
    name: PyPI ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: deploy-test
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: PyPI ãƒ“ãƒ«ãƒ‰ & å…¬é–‹
        uses: JRubics/poetry-publish@v2.1
        with:
          python_version: "3.13"
          poetry_version: "latest"
          pypi_token: ${{ secrets.PYPI_API_TOKEN }}

      - name: PyPI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
        run: |
          sleep 60  # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åæ˜ ã‚’å¾…ã¤
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            release_version="${{ inputs.tag_name }}"
          else
            release_version="${{ github.event.release.tag_name }}"
          fi
          release_version=${release_version#v}
          
          pip install lambapi==$release_version || {
            echo "âŒ PyPI ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          
          # åŸºæœ¬å‹•ä½œç¢ºèª
          python -c "
          from lambapi import API
          api = API({}, None, '/api/v1')
          assert api.root_path == '/api/v1'
          print('âœ… PyPI ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™')
          "

  notify-success:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-test, deploy-production]
    if: success()
    
    steps:
      - name: æˆåŠŸé€šçŸ¥
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            release_version="${{ inputs.tag_name }}"
          else
            release_version="${{ github.event.release.tag_name }}"
          fi
          release_version=${release_version#v}
          
          echo "ğŸ‰ PyPI ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ“¦ PyPI: https://pypi.org/project/lambapi/$release_version/"
          echo "ğŸ§ª TestPyPI: https://test.pypi.org/project/lambapi/$release_version/"
          echo ""
          echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:"
          echo "pip install lambapi==$release_version"

  notify-failure:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-test, deploy-production]
    if: failure()
    
    steps:
      - name: å¤±æ•—é€šçŸ¥
        run: |
          echo "âŒ PyPI ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"